###############################################################################
# RF9 - Dashboard de Acompanhamento - API Collection
# TalentMatchIA - Sistema de Recrutamento Inteligente
# 
# Endpoints:
# - Overview Consolidado (3 endpoints)
# - CRUD de Presets (5 endpoints)
###############################################################################

@baseUrl = http://localhost:3000/api
@token = SEU_TOKEN_AQUI

### 1. LOGIN (obter token primeiro)
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "recrutador@empresa.com",
  "senha": "Senha123!"
}

###############################################################################
# OVERVIEW CONSOLIDADO
###############################################################################

### 2. GET Overview Consolidado (26+ métricas em uma chamada)
# Retorna: global (13 métricas), presets (8 métricas), conversion (5 métricas)
GET {{baseUrl}}/dashboard/overview
Authorization: Bearer {{token}}

### 3. GET Activity Timeline (últimos 30 dias)
GET {{baseUrl}}/dashboard/activity-timeline?days=30
Authorization: Bearer {{token}}

### 4. GET Activity Timeline (últimos 7 dias)
GET {{baseUrl}}/dashboard/activity-timeline?days=7
Authorization: Bearer {{token}}

### 5. GET Activity Timeline (últimos 90 dias)
GET {{baseUrl}}/dashboard/activity-timeline?days=90
Authorization: Bearer {{token}}

### 6. GET Conversion Funnel (todas as vagas)
GET {{baseUrl}}/dashboard/conversion-funnel
Authorization: Bearer {{token}}

### 7. GET Conversion Funnel (vagas abertas apenas)
GET {{baseUrl}}/dashboard/conversion-funnel?status=open
Authorization: Bearer {{token}}

### 8. GET Conversion Funnel (ordenado por taxa de aprovação)
GET {{baseUrl}}/dashboard/conversion-funnel?sort=interview_to_approval_rate&order=DESC
Authorization: Bearer {{token}}

### 9. GET Conversion Funnel (ordenado por volume de currículos)
GET {{baseUrl}}/dashboard/conversion-funnel?sort=total_resumes&order=DESC&limit=10
Authorization: Bearer {{token}}

###############################################################################
# CRUD DE PRESETS
###############################################################################

### 10. POST Criar Preset - Configuração Básica
POST {{baseUrl}}/dashboard/presets
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Meu Dashboard Principal",
  "description": "Visão geral focada em vagas abertas",
  "filters": {
    "period": "last_30_days",
    "jobStatus": ["open"],
    "interviewStatus": ["scheduled", "in_progress"]
  },
  "layout": {
    "widgets": ["kpi-cards", "activity-chart", "conversion-funnel"],
    "order": ["kpis", "timeline", "funnel"]
  },
  "preferences": {
    "theme": "light",
    "chartType": "line",
    "showLegends": true
  },
  "is_default": true,
  "is_shared": false
}

### 11. POST Criar Preset - Foco em Entrevistas
POST {{baseUrl}}/dashboard/presets
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Dashboard de Entrevistas",
  "description": "Acompanhamento detalhado de entrevistas",
  "filters": {
    "period": "last_7_days",
    "interviewStatus": ["scheduled", "in_progress", "completed"],
    "showOnlyMyInterviews": true
  },
  "layout": {
    "widgets": ["interviews-timeline", "assessments-stats", "completion-rate"],
    "order": ["timeline", "stats", "rate"]
  },
  "preferences": {
    "theme": "dark",
    "chartType": "bar",
    "autoRefresh": 300
  },
  "is_default": false,
  "is_shared": false
}

### 12. POST Criar Preset - Compartilhado com Time
POST {{baseUrl}}/dashboard/presets
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Dashboard Executivo",
  "description": "Métricas estratégicas para gestores",
  "filters": {
    "period": "last_90_days",
    "showTrends": true
  },
  "layout": {
    "widgets": ["global-kpis", "conversion-funnel", "user-stats"],
    "order": ["kpis", "funnel", "users"]
  },
  "preferences": {
    "theme": "light",
    "chartType": "line",
    "showComparisons": true
  },
  "is_default": false,
  "is_shared": true,
  "shared_with_roles": ["ADMIN", "RECRUITER"]
}

### 13. POST Criar Preset - Análise de Conversão
POST {{baseUrl}}/dashboard/presets
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Análise de Funil",
  "description": "Foco em taxas de conversão e gargalos",
  "filters": {
    "period": "last_60_days",
    "jobStatus": ["open", "filled"],
    "minResumes": 5
  },
  "layout": {
    "widgets": ["conversion-funnel", "drop-off-analysis", "time-to-hire"],
    "order": ["funnel", "analysis", "time"]
  },
  "preferences": {
    "theme": "light",
    "chartType": "sankey",
    "highlightBottlenecks": true
  },
  "is_default": false,
  "is_shared": true,
  "shared_with_roles": ["ADMIN"]
}

### 14. POST Criar Preset - Validação de Nome Vazio (ERRO)
POST {{baseUrl}}/dashboard/presets
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "",
  "description": "Teste de validação",
  "filters": {}
}

### 15. GET Listar Todos os Presets (próprios + compartilhados)
GET {{baseUrl}}/dashboard/presets
Authorization: Bearer {{token}}

### 16. GET Listar Presets (ordenado por uso)
GET {{baseUrl}}/dashboard/presets?sort=usage_count&order=DESC
Authorization: Bearer {{token}}

### 17. GET Listar Presets (ordenado por data de criação)
GET {{baseUrl}}/dashboard/presets?sort=created_at&order=DESC
Authorization: Bearer {{token}}

### 18. GET Listar Presets (ordenado por último uso)
GET {{baseUrl}}/dashboard/presets?sort=last_used_at&order=DESC
Authorization: Bearer {{token}}

### 19. GET Listar Presets (apenas compartilhados)
GET {{baseUrl}}/dashboard/presets?is_shared=true
Authorization: Bearer {{token}}

### 20. GET Listar Presets (apenas defaults)
GET {{baseUrl}}/dashboard/presets?is_default=true
Authorization: Bearer {{token}}

### 21. GET Listar Presets (busca textual)
GET {{baseUrl}}/dashboard/presets?search=entrevista
Authorization: Bearer {{token}}

### 22. GET Listar Presets (paginação)
GET {{baseUrl}}/dashboard/presets?page=1&limit=10
Authorization: Bearer {{token}}

### 23. GET Buscar Preset Específico
# Substitua {preset_id} pelo ID retornado em criações anteriores
GET {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}

### 24. GET Buscar Preset Inexistente (ERRO 404)
GET {{baseUrl}}/dashboard/presets/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{token}}

### 25. PUT Atualizar Preset - Apenas Nome
PUT {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Dashboard Principal (Atualizado)"
}

### 26. PUT Atualizar Preset - Apenas Descrição
PUT {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "description": "Nova descrição detalhada do preset"
}

### 27. PUT Atualizar Preset - Apenas Filtros
PUT {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "filters": {
    "period": "last_60_days",
    "jobStatus": ["open", "closed"],
    "department": "Engineering"
  }
}

### 28. PUT Atualizar Preset - Apenas Layout
PUT {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "layout": {
    "widgets": ["kpi-cards", "timeline", "funnel", "user-stats"],
    "order": ["kpis", "timeline", "funnel", "users"],
    "columns": 2
  }
}

### 29. PUT Atualizar Preset - Apenas Preferências
PUT {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "preferences": {
    "theme": "dark",
    "chartType": "bar",
    "autoRefresh": 600,
    "showLegends": false
  }
}

### 30. PUT Atualizar Preset - Marcar como Default
PUT {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "is_default": true
}

### 31. PUT Atualizar Preset - Compartilhar
PUT {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "is_shared": true,
  "shared_with_roles": ["ADMIN", "RECRUITER", "USER"]
}

### 32. PUT Atualizar Preset - Completo
PUT {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Dashboard Completo Atualizado",
  "description": "Versão final do dashboard principal",
  "filters": {
    "period": "last_30_days",
    "jobStatus": ["open"]
  },
  "layout": {
    "widgets": ["all"],
    "order": ["auto"]
  },
  "preferences": {
    "theme": "system",
    "chartType": "auto"
  },
  "is_default": true,
  "is_shared": true,
  "shared_with_roles": ["ADMIN"]
}

### 33. PUT Atualizar Preset Inexistente (ERRO 404)
PUT {{baseUrl}}/dashboard/presets/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Teste"
}

### 34. PUT Atualizar Preset Sem Campos (ERRO 400)
PUT {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}
Content-Type: application/json

{}

### 35. DELETE Deletar Preset (Soft Delete)
DELETE {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}

### 36. DELETE Deletar Preset Inexistente (ERRO 404)
DELETE {{baseUrl}}/dashboard/presets/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{token}}

### 37. GET Verificar Preset Deletado (ERRO 404)
GET {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}

###############################################################################
# FLUXOS E2E
###############################################################################

### 38. E2E - Criar, Usar e Atualizar Preset
# 1. Criar preset
POST {{baseUrl}}/dashboard/presets
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "E2E Test Dashboard",
  "filters": {"period": "last_7_days"},
  "is_default": false
}

# 2. Listar presets (deve aparecer o criado)
# GET {{baseUrl}}/dashboard/presets

# 3. Buscar o preset específico (incrementa usage_count)
# GET {{baseUrl}}/dashboard/presets/{id_do_preset_criado}

# 4. Atualizar preset
# PUT {{baseUrl}}/dashboard/presets/{id_do_preset_criado}
# { "name": "E2E Test Dashboard (Updated)" }

# 5. Buscar novamente (usage_count deve ser 2)
# GET {{baseUrl}}/dashboard/presets/{id_do_preset_criado}

# 6. Deletar preset
# DELETE {{baseUrl}}/dashboard/presets/{id_do_preset_criado}

###############################################################################
# CENÁRIOS DE SEGURANÇA
###############################################################################

### 39. Tentar acessar preset de outra company (ERRO 404)
# Precisaria de dois usuários de companies diferentes
GET {{baseUrl}}/dashboard/presets/{preset_id_de_outra_company}
Authorization: Bearer {{token}}

### 40. Tentar atualizar preset de outro usuário (ERRO 404)
PUT {{baseUrl}}/dashboard/presets/{preset_id_de_outro_usuario}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Tentativa de Hack"
}

### 41. Tentar deletar preset de outro usuário (ERRO 404)
DELETE {{baseUrl}}/dashboard/presets/{preset_id_de_outro_usuario}
Authorization: Bearer {{token}}

### 42. Acessar overview sem autenticação (ERRO 401)
GET {{baseUrl}}/dashboard/overview

### 43. Criar preset sem autenticação (ERRO 401)
POST {{baseUrl}}/dashboard/presets
Content-Type: application/json

{
  "name": "Teste Sem Auth"
}

###############################################################################
# PERFORMANCE E EDGE CASES
###############################################################################

### 44. GET Overview com company sem dados
GET {{baseUrl}}/dashboard/overview
Authorization: Bearer {{token}}

### 45. GET Activity Timeline - Período grande (1 ano)
GET {{baseUrl}}/dashboard/activity-timeline?days=365
Authorization: Bearer {{token}}

### 46. GET Conversion Funnel - Limite máximo
GET {{baseUrl}}/dashboard/conversion-funnel?limit=100
Authorization: Bearer {{token}}

### 47. Criar Preset com JSONB muito grande
POST {{baseUrl}}/dashboard/presets
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Preset Grande",
  "filters": {
    "field1": "value1",
    "field2": "value2",
    "nested": {
      "deep": {
        "very": {
          "nested": "data"
        }
      }
    },
    "array": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
  },
  "layout": {
    "widgets": ["w1", "w2", "w3", "w4", "w5"],
    "config": {
      "w1": {"x": 0, "y": 0, "w": 6, "h": 4},
      "w2": {"x": 6, "y": 0, "w": 6, "h": 4},
      "w3": {"x": 0, "y": 4, "w": 4, "h": 4},
      "w4": {"x": 4, "y": 4, "w": 4, "h": 4},
      "w5": {"x": 8, "y": 4, "w": 4, "h": 4}
    }
  }
}

### 48. Listar Presets - Paginação extrema
GET {{baseUrl}}/dashboard/presets?page=999&limit=100
Authorization: Bearer {{token}}

### 49. Buscar Preset e verificar incremento de usage_count (3x)
# Primeira busca
GET {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}

###
# Segunda busca
GET {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}

###
# Terceira busca
GET {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}

### 50. Marcar múltiplos presets como default (apenas último deve ficar)
# Criar preset 1 como default
POST {{baseUrl}}/dashboard/presets
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Default 1",
  "is_default": true
}

###
# Criar preset 2 como default (deve desmarcar o anterior)
POST {{baseUrl}}/dashboard/presets
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Default 2",
  "is_default": true
}

###
# Listar e verificar que apenas Default 2 está com is_default=true
GET {{baseUrl}}/dashboard/presets?is_default=true
Authorization: Bearer {{token}}

###############################################################################
# VALIDAÇÕES AVANÇADAS
###############################################################################

### 51. Criar preset com nome apenas espaços (ERRO 400)
POST {{baseUrl}}/dashboard/presets
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "   ",
  "filters": {}
}

### 52. Atualizar preset com nome apenas espaços (deve falhar por constraint)
PUT {{baseUrl}}/dashboard/presets/{preset_id}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "   "
}

### 53. Criar preset com shared_with_roles inválidos
POST {{baseUrl}}/dashboard/presets
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Teste Roles",
  "is_shared": true,
  "shared_with_roles": ["INVALID_ROLE", "ADMIN"]
}

### 54. Buscar presets compartilhados com role específico
GET {{baseUrl}}/dashboard/presets?is_shared=true
Authorization: Bearer {{token}}

### 55. Activity Timeline - Período inválido (deve usar default 30)
GET {{baseUrl}}/dashboard/activity-timeline?days=abc
Authorization: Bearer {{token}}

### 56. Conversion Funnel - Sort inválido (deve usar default)
GET {{baseUrl}}/dashboard/conversion-funnel?sort=invalid_column
Authorization: Bearer {{token}}

### 57. Conversion Funnel - Order inválido (deve usar default DESC)
GET {{baseUrl}}/dashboard/conversion-funnel?order=INVALID
Authorization: Bearer {{token}}

###############################################################################
# FIM
###############################################################################
