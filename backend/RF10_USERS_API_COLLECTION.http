###
# RF10 - User Management API Collection
# TalentMatchAI - Gerenciamento de Usuários
#
# Pré-requisitos:
# 1. Servidor rodando: npm start (porta 3000)
# 2. Migrations 024-025 aplicadas
# 3. Token de autenticação válido (substitua {{token}} abaixo)
#
# Endpoints Testados:
# - POST   /api/usuarios                  - Criar usuário
# - POST   /api/usuarios/invite           - Convidar usuário
# - POST   /api/usuarios/accept-invite    - Aceitar convite
# - GET    /api/usuarios                  - Listar usuários
# - GET    /api/usuarios/:id              - Detalhes do usuário
# - PUT    /api/usuarios/:id              - Atualizar usuário
# - DELETE /api/usuarios/:id              - Soft delete
# - GET    /api/dashboard/users/*         - Métricas (7 endpoints)
###

@baseUrl = http://localhost:3000/api
@token = seu_token_aqui
@userId = 
@invitationToken = 

# ============================================================================
# AUTHENTICATION - Obter token para testes
# ============================================================================

### 1. Login como ADMIN (para obter token)
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "admin@example.com",
  "password": "admin123"
}

# ============================================================================
# CRUD - CREATE (Criar Usuário Diretamente)
# ============================================================================

### 2. Criar usuário USER básico
POST {{baseUrl}}/usuarios
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "full_name": "João Silva",
  "email": "joao.silva@example.com",
  "password": "senha123",
  "role": "USER",
  "phone": "+55 11 98765-4321",
  "department": "Tecnologia",
  "job_title": "Desenvolvedor",
  "is_active": true,
  "email_verified": false
}

### 3. Criar RECRUITER com todos os campos
POST {{baseUrl}}/usuarios
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "full_name": "Maria Santos",
  "email": "maria.santos@example.com",
  "password": "senha456",
  "role": "RECRUITER",
  "phone": "+55 21 99876-5432",
  "department": "Recursos Humanos",
  "job_title": "Recrutadora Sênior",
  "bio": "10 anos de experiência em recrutamento técnico",
  "is_active": true,
  "email_verified": true
}

### 4. Criar ADMIN
POST {{baseUrl}}/usuarios
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "full_name": "Carlos Admin",
  "email": "carlos.admin@example.com",
  "password": "admin456",
  "role": "ADMIN",
  "department": "Gestão",
  "job_title": "Gerente de RH",
  "is_active": true,
  "email_verified": true
}

### 5. Criar usuário sem senha (deve resetar)
POST {{baseUrl}}/usuarios
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "full_name": "Ana Costa",
  "email": "ana.costa@example.com",
  "role": "USER",
  "department": "Marketing"
}

### 6. ERRO: Criar usuário sem campos obrigatórios
POST {{baseUrl}}/usuarios
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "role": "USER"
}

### 7. ERRO: Criar usuário com role inválido
POST {{baseUrl}}/usuarios
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "full_name": "Teste Inválido",
  "email": "teste@example.com",
  "password": "senha123",
  "role": "INVALID_ROLE"
}

### 8. ERRO: Email duplicado
POST {{baseUrl}}/usuarios
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "full_name": "Duplicado",
  "email": "joao.silva@example.com",
  "password": "senha123",
  "role": "USER"
}

# ============================================================================
# INVITATION FLOW - Convidar e Aceitar
# ============================================================================

### 9. Convidar novo usuário (USER)
POST {{baseUrl}}/usuarios/invite
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "full_name": "Pedro Oliveira",
  "email": "pedro.oliveira@example.com",
  "role": "USER",
  "phone": "+55 11 91234-5678",
  "department": "Vendas",
  "job_title": "Analista de Vendas",
  "expires_in_days": 7
}

### 10. Convidar RECRUITER com expiração customizada
POST {{baseUrl}}/usuarios/invite
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "full_name": "Lucia Ferreira",
  "email": "lucia.ferreira@example.com",
  "role": "RECRUITER",
  "department": "RH",
  "job_title": "Recrutadora",
  "expires_in_days": 3
}

### 11. ERRO: Convidar com email já existente
POST {{baseUrl}}/usuarios/invite
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "full_name": "Duplicado",
  "email": "joao.silva@example.com",
  "role": "USER"
}

### 12. ERRO: Convidar sem campos obrigatórios
POST {{baseUrl}}/usuarios/invite
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "role": "USER"
}

### 13. Aceitar convite (usar token real da resposta do POST invite)
# Nota: Esta é uma rota PÚBLICA (não precisa de Authorization)
POST {{baseUrl}}/usuarios/accept-invite
Content-Type: application/json

{
  "invitation_token": "{{invitationToken}}",
  "password": "novaSenha123",
  "preferences": {
    "language": "pt-BR",
    "theme": "dark",
    "notifications": {
      "email": true,
      "push": false
    }
  }
}

### 14. ERRO: Aceitar com token inválido
POST {{baseUrl}}/usuarios/accept-invite
Content-Type: application/json

{
  "invitation_token": "token_invalido_12345",
  "password": "senha123"
}

### 15. ERRO: Aceitar sem senha
POST {{baseUrl}}/usuarios/accept-invite
Content-Type: application/json

{
  "invitation_token": "{{invitationToken}}"
}

# ============================================================================
# CRUD - READ (Listar e Detalhes)
# ============================================================================

### 16. Listar todos os usuários (sem filtros)
GET {{baseUrl}}/usuarios
Authorization: Bearer {{token}}

### 17. Listar usuários - paginação
GET {{baseUrl}}/usuarios?page=1&limit=10
Authorization: Bearer {{token}}

### 18. Filtrar por role (USER)
GET {{baseUrl}}/usuarios?role=USER
Authorization: Bearer {{token}}

### 19. Filtrar por role (RECRUITER)
GET {{baseUrl}}/usuarios?role=RECRUITER
Authorization: Bearer {{token}}

### 20. Filtrar por role (ADMIN)
GET {{baseUrl}}/usuarios?role=ADMIN
Authorization: Bearer {{token}}

### 21. Filtrar por department
GET {{baseUrl}}/usuarios?department=Tecnologia
Authorization: Bearer {{token}}

### 22. Filtrar por is_active (ativos)
GET {{baseUrl}}/usuarios?is_active=true
Authorization: Bearer {{token}}

### 23. Filtrar por is_active (inativos)
GET {{baseUrl}}/usuarios?is_active=false
Authorization: Bearer {{token}}

### 24. Filtrar por email_verified (verificados)
GET {{baseUrl}}/usuarios?email_verified=true
Authorization: Bearer {{token}}

### 25. Filtrar por email_verified (não verificados)
GET {{baseUrl}}/usuarios?email_verified=false
Authorization: Bearer {{token}}

### 26. Buscar por texto (nome, email, department, job_title)
GET {{baseUrl}}/usuarios?search=joão
Authorization: Bearer {{token}}

### 27. Ordenar por created_at DESC (padrão)
GET {{baseUrl}}/usuarios?sort=created_at&order=DESC
Authorization: Bearer {{token}}

### 28. Ordenar por full_name ASC
GET {{baseUrl}}/usuarios?sort=full_name&order=ASC
Authorization: Bearer {{token}}

### 29. Ordenar por last_login_at DESC (usuários ativos recentes)
GET {{baseUrl}}/usuarios?sort=last_login_at&order=DESC
Authorization: Bearer {{token}}

### 30. Filtros combinados: RECRUITER + RH + ativos
GET {{baseUrl}}/usuarios?role=RECRUITER&department=RH&is_active=true
Authorization: Bearer {{token}}

### 31. Filtros combinados + busca + ordenação
GET {{baseUrl}}/usuarios?role=USER&search=silva&sort=full_name&order=ASC
Authorization: Bearer {{token}}

### 32. Detalhes de usuário específico (substitua {{userId}})
GET {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}

### 33. ERRO: Detalhes de usuário inexistente
GET {{baseUrl}}/usuarios/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{token}}

# ============================================================================
# CRUD - UPDATE (Atualizar Usuário)
# ============================================================================

### 34. Atualizar dados básicos
PUT {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "full_name": "João Silva Atualizado",
  "phone": "+55 11 91111-2222",
  "job_title": "Desenvolvedor Sênior"
}

### 35. Atualizar department
PUT {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "department": "Engenharia"
}

### 36. Atualizar role (promover USER → RECRUITER)
PUT {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "role": "RECRUITER"
}

### 37. Atualizar bio
PUT {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "bio": "Desenvolvedor full-stack com 8 anos de experiência em Node.js e React"
}

### 38. Desativar usuário
PUT {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "is_active": false
}

### 39. Reativar usuário
PUT {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "is_active": true
}

### 40. Marcar email como verificado
PUT {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "email_verified": true
}

### 41. Atualizar preferences
PUT {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "preferences": {
    "language": "en-US",
    "theme": "light",
    "notifications": {
      "email": true,
      "push": true,
      "sms": false
    },
    "dashboard": {
      "default_view": "kanban",
      "show_charts": true
    }
  }
}

### 42. Redefinir senha (reseta failed_login_attempts)
PUT {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "password": "novaSenhaMaisSegura456"
}

### 43. Atualização completa (múltiplos campos)
PUT {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "full_name": "João Pedro Silva",
  "email": "joao.pedro@example.com",
  "role": "ADMIN",
  "phone": "+55 11 99999-8888",
  "department": "Gestão de Pessoas",
  "job_title": "Coordenador de RH",
  "bio": "Especialista em gestão de pessoas e recrutamento técnico",
  "is_active": true,
  "email_verified": true
}

### 44. ERRO: Atualizar sem campos
PUT {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{}

### 45. ERRO: Atualizar com role inválido
PUT {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "role": "INVALID"
}

### 46. ERRO: Atualizar email para duplicado
PUT {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "email": "maria.santos@example.com"
}

### 47. ERRO: Atualizar usuário inexistente
PUT {{baseUrl}}/usuarios/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "full_name": "Teste"
}

# ============================================================================
# CRUD - DELETE (Soft Delete)
# ============================================================================

### 48. Soft delete de usuário
DELETE {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}

### 49. ERRO: Delete de usuário inexistente
DELETE {{baseUrl}}/usuarios/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{token}}

### 50. ERRO: Tentar deletar a própria conta
# Nota: Substitua {{userId}} pelo ID do usuário logado
DELETE {{baseUrl}}/usuarios/{{userId}}
Authorization: Bearer {{token}}

# ============================================================================
# DASHBOARD - Métricas de Usuários
# ============================================================================

### 51. Métricas consolidadas (17 KPIs)
GET {{baseUrl}}/dashboard/users/metrics
Authorization: Bearer {{token}}

### 52. Distribuição por role
GET {{baseUrl}}/dashboard/users/by-role
Authorization: Bearer {{token}}

### 53. Distribuição por department
GET {{baseUrl}}/dashboard/users/by-department
Authorization: Bearer {{token}}

### 54. Timeline de login (últimos 30 dias)
GET {{baseUrl}}/dashboard/users/login-timeline?days=30
Authorization: Bearer {{token}}

### 55. Timeline de login (últimos 7 dias)
GET {{baseUrl}}/dashboard/users/login-timeline?days=7
Authorization: Bearer {{token}}

### 56. Timeline de registro (últimos 90 dias)
GET {{baseUrl}}/dashboard/users/registration-timeline?days=90
Authorization: Bearer {{token}}

### 57. Timeline de registro (últimos 30 dias)
GET {{baseUrl}}/dashboard/users/registration-timeline?days=30
Authorization: Bearer {{token}}

### 58. Estatísticas de segurança
GET {{baseUrl}}/dashboard/users/security-stats
Authorization: Bearer {{token}}

### 59. Estatísticas de convites
GET {{baseUrl}}/dashboard/users/invitation-stats
Authorization: Bearer {{token}}

# ============================================================================
# SECURITY & VALIDATION - Testes de Segurança
# ============================================================================

### 60. ERRO: Criar usuário sem autenticação
POST {{baseUrl}}/usuarios
Content-Type: application/json

{
  "full_name": "Teste Sem Auth",
  "email": "teste@example.com",
  "password": "senha123",
  "role": "USER"
}

### 61. ERRO: Listar usuários sem autenticação
GET {{baseUrl}}/usuarios

### 62. ERRO: Atualizar sem autenticação
PUT {{baseUrl}}/usuarios/{{userId}}
Content-Type: application/json

{
  "full_name": "Teste"
}

### 63. ERRO: Deletar sem autenticação
DELETE {{baseUrl}}/usuarios/{{userId}}

### 64. ERRO: Dashboard sem autenticação
GET {{baseUrl}}/dashboard/users/metrics

# ============================================================================
# EDGE CASES & BOUNDARY TESTS
# ============================================================================

### 65. Paginação - primeira página
GET {{baseUrl}}/usuarios?page=1&limit=5
Authorization: Bearer {{token}}

### 66. Paginação - página inexistente (deve retornar array vazio)
GET {{baseUrl}}/usuarios?page=999&limit=10
Authorization: Bearer {{token}}

### 67. Paginação - limit=1 (mínimo)
GET {{baseUrl}}/usuarios?page=1&limit=1
Authorization: Bearer {{token}}

### 68. Busca sem resultados
GET {{baseUrl}}/usuarios?search=usuarioquenadaexiste123
Authorization: Bearer {{token}}

### 69. Filtro por department inexistente
GET {{baseUrl}}/usuarios?department=DepartamentoInexistente
Authorization: Bearer {{token}}

### 70. Ordenação por campo inválido (deve usar default)
GET {{baseUrl}}/usuarios?sort=campo_invalido&order=DESC
Authorization: Bearer {{token}}

# ============================================================================
# NOTAS FINAIS
# ============================================================================

###
# ATENÇÃO:
# 1. Substitua {{token}} por um token válido obtido em /auth/login
# 2. Substitua {{userId}} por um ID real retornado nas criações
# 3. Substitua {{invitationToken}} pelo token da resposta do POST /invite
# 4. Para testar invitation flow completo:
#    - Execute request #9 (invite)
#    - Copie invitation_token da resposta
#    - Cole em {{invitationToken}}
#    - Execute request #13 (accept-invite)
# 5. Migrations 024-025 devem estar aplicadas
# 6. Servidor deve estar rodando na porta 3000
###
